import streamlit as st
import PyPDF2
import google.generativeai as genai
import gspread
import re
import pandas as pd
from google.oauth2.service_account import Credentials
from datetime import datetime

# ---------------- CONFIGURA√á√ÉO DA P√ÅGINA ----------------
st.set_page_config(
    page_title="CV Optimizer Pro V2",
    page_icon="üéØ",
    layout="wide"
)

# ---------------- CSS (UX OTIMIZADO) ----------------
st.markdown("""
<style>
    .stApp { background-color: #0E1117; color: #E0E0E0; }
    .main-header { color: #A78BFA; font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; }
    
    /* Cards de an√°lise */
    .metric-card {
        background: #1F2937;
        padding: 20px;
        border-radius: 12px;
        border-top: 4px solid #8B5CF6;
        text-align: center;
    }
    
    /* Melhoria no Uploader */
    [data-testid="stFileUploader"] {
        border: 2px dashed #6D28D9;
        border-radius: 12px;
    }

    /* Bot√£o de A√ß√£o */
    .stButton > button { 
        background: linear-gradient(90deg, #7C3AED 0%, #6D28D9 100%);
        transition: all 0.3s ease;
        border: none;
        height: 3.5rem;
    }
    .stButton > button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(124, 58, 237, 0.4); }
</style>
""", unsafe_allow_html=True)

# ---------------- CONFIG ----------------
try:
    genai.configure(api_key=st.secrets["GEMINI_API_KEY"])
except Exception as e:
    st.error("Erro de conex√£o. Verifique a chave de API.")
    st.stop()

# ---------------- FUN√á√ïES T√âCNICAS (CORRIGIDAS) ----------------

def extrair_texto_pdf(arquivo):
    reader = PyPDF2.PdfReader(arquivo)
    texto = ""
    for page in reader.pages:
        content = page.extract_text()
        if content: texto += content
    return texto

def extrair_nota_robusta(texto):
    """
    CORRE√á√ÉO: Regex flex√≠vel para capturar a nota mesmo com 
    formata√ß√£o Markdown ou negritos extras.
    """
    # Procura por "Nota" seguido de qualquer coisa at√© encontrar n√∫meros
    match = re.search(r'(?:Nota|Minha Nota).*?(\d+)', texto, re.IGNORECASE | re.DOTALL)
    if match:
        return int(match.group(1))
    return 0

def chamar_ia_agente_fiel(dados_cv, dados_vaga):
    model = genai.GenerativeModel("gemini-1.5-flash")
    
    # PROMPT COM TRAVA DE FIDELIDADE
    prompt_mestre = f"""
    Atue como uma Especialista em Recoloca√ß√£o e ATS.
    
    CONTEXTO: O usu√°rio quer otimizar o curr√≠culo para uma vaga espec√≠fica.
    REGRA DE OURO: Voc√™ est√° PROIBIDA de inventar experi√™ncias, cargos ou ferramentas que n√£o estejam no curr√≠culo original. 
    Se a vaga pedir algo que o candidato n√£o tem, mencione isso na AN√ÅLISE como um "Ponto de Aten√ß√£o", mas N√ÉO inclua no documento otimizado.

    TAREFA 1: AN√ÅLISE (Direta e Sincera)
    1. **Onde voc√™ brilha ‚ú®**
    2. **Cuidado com isso ‚ö†Ô∏è** (Destaque aqui as compet√™ncias que a vaga pede mas o candidato N√ÉO possui)
    3. **Minha Nota:** X%
    4. **Veredito**

    TAREFA 2: CURR√çCULO OTIMIZADO
    Reescreva o curr√≠culo priorizando os termos da vaga que o candidato REALMENTE possui.
    - Melhore a escrita das conquistas.
    - N√ÉO adicione ferramentas ou cursos n√£o citados no original.
    
    ---DIVISOR_CV---
    (Texto do Novo CV aqui)
    
    ---DIVISOR_DADOS---
    CANDIDATO: (Resumo curto)
    VAGA: (Resumo curto)
    MUDANCA: (O que foi priorizado)
    
    DADOS:
    CV ORIGINAL: {dados_cv}
    VAGA ALVO: {dados_vaga}
    """
    
    resposta = model.generate_content(prompt_mestre).text
    return resposta

# ---------------- INTERFACE ----------------

st.markdown('<h1 class="main-header">CV Optimizer Pro <span style="font-size: 1rem; vertical-align: middle; color: #6D28D9;">V2.0</span></h1>', unsafe_allow_html=True)

with st.expander("‚ÑπÔ∏è Como funciona o Agente de Fidelidade", expanded=False):
    st.write("""
    Nesta vers√£o, a IA foi instru√≠da a ser **100% fiel ao seu hist√≥rico**. 
    Diferente de outros geradores, ela n√£o "inventar√°" habilidades que voc√™ n√£o tem apenas para enganar o RH. 
    Se houver um gap, ela te avisar√° no diagn√≥stico.
    """)

col1, col2 = st.columns([1, 1.2])

with col1:
    st.subheader("üìÑ Seus Dados")
    email = st.text_input("E-mail para registro", placeholder="seu@email.com")
    pdf = st.file_uploader("Upload do CV Original (PDF)", type="pdf")

with col2:
    st.subheader("üéØ Vaga Alvo")
    vaga = st.text_area("Descri√ß√£o da Oportunidade", height=230, placeholder="Cole aqui os requisitos da vaga...")

st.divider()
aceite = st.checkbox("Estou ciente que esta ferramenta analisa e armazena os dados para fins de otimiza√ß√£o profissional.")

if st.button("üöÄ Gerar Otimiza√ß√£o Estrat√©gica"):
    if not (email and pdf and vaga and aceite):
        st.warning("‚ö†Ô∏è Por favor, preencha todos os campos e aceite os termos.")
    else:
        with st.spinner("ü§ñ Agente analisando fidelidade e extraindo dados..."):
            try:
                texto_cv = extrair_texto_pdf(pdf)
                resposta_completa = chamar_ia_agente_fiel(texto_cv, vaga)
                
                # Parsing inteligente
                partes_cv = resposta_completa.split("---DIVISOR_CV---")
                analise = partes_cv[0].strip()
                
                restante = partes_cv[1] if len(partes_cv) > 1 else ""
                partes_dados = restante.split("---DIVISOR_DADOS---")
                
                novo_cv = partes_dados[0].strip()
                nota = extrair_nota_robusta(analise)

                # EXIBI√á√ÉO EM ABAS (Melhoria de UX)
                aba1, aba2 = st.tabs(["üìä Diagn√≥stico de Match", "‚ú® Novo Curr√≠culo"])
                
                with aba1:
                    c1, c2 = st.columns([1, 3])
                    with c1:
                        st.markdown(f"""
                        <div class="metric-card">
                            <small>Compatibilidade</small>
                            <h2 style="color: #A78BFA; margin:0;">{nota}%</h2>
                        </div>
                        """, unsafe_allow_html=True)
                    with c2:
                        if nota > 75: st.success("Excelente! Suas experi√™ncias reais t√™m forte ader√™ncia.")
                        else: st.info("Focamos em real√ßar o que voc√™ j√° tem para subir suas chances.")
                    
                    st.markdown(analise)
                
                with aba2:
                    st.info("üí° Este curr√≠culo foi gerado sem inventar dados. Copie o texto abaixo:")
                    st.text_area("Conte√∫do pronto para copiar:", value=novo_cv, height=450)
                    st.download_button("Baixar como TXT", data=novo_cv, file_name="curriculo_otimizado.txt")
                
                st.balloons()

            except Exception as e:
                st.error(f"Houve um erro no processamento: {e}")